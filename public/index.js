var O,K,J=null,W=null,T=null;var C,$=!0,X=0,Y=0,F=5;function G(){let j=new URLSearchParams(window.location.search),A=j.get("urllat"),q=j.get("urllng");return{urllat:A?parseFloat(A):null,urllng:q?parseFloat(q):null}}function N(){b(),O=new google.maps.Map(document.getElementById("map"),{center:{lat:0,lng:0},zoom:2,streetViewControl:!1,fullscreenControl:!1}),K=new google.maps.StreetViewPanorama(document.getElementById("street-view"),{position:{lat:0,lng:0},pov:{heading:0,pitch:0},zoom:1,addressControl:!1,showRoadLabels:!1}),O.addListener("click",(j)=>{if($&&j.latLng)D(j.latLng)}),I()}function b(){let j=document.createElement("div");j.className="game-controls",j.innerHTML=`
      <div class="game-info">
        <div id="score">Score: 0</div>
        <div id="round">Round: 1/${F}</div>
      </div>
      <button id="guess-btn" disabled>Make Guess</button>
      <button id="next-btn" disabled>Next Round</button>
    `,document.getElementsByClassName("controls-container")[0].appendChild(j),document.getElementById("guess-btn")?.addEventListener("click",x),document.getElementById("next-btn")?.addEventListener("click",I)}async function I(){V(),$=!0,Y++,w();let j=document.getElementById("guess-btn"),A=document.getElementById("next-btn");j.disabled=!0,A.disabled=!0;try{let{urllat:q,urllng:H}=G();if(q!==null&&H!==null){C={lat:q,lng:H};let z=new google.maps.StreetViewService,Q=5000,Z=new google.maps.LatLng(C.lat,C.lng);z.getPanorama({location:Z,radius:Q},async(_,y)=>{if(y===google.maps.StreetViewStatus.OK&&_&&_.location)K.setPano(_.location.pano),K.setPov({heading:0,pitch:0}),K.setVisible(!0);else console.warn("No Street View found for URL parameters location.")})}else await U()}catch(q){console.error("Error fetching location:",q),alert("Error fetching location. Please try again.")}}async function U(){try{let j=await B();if(!j)throw new Error("Failed to fetch a valid location.");C=j;let A=new google.maps.LatLng(C.lat,C.lng);return new Promise((q,H)=>{new google.maps.StreetViewService().getPanorama({location:A,radius:5000},(Q,Z)=>{if(Z===google.maps.StreetViewStatus.OK&&Q&&Q.location)K.setPano(Q.location.pano),K.setPov({heading:0,pitch:0}),K.setVisible(!0),q(!0);else console.warn("No Street View found, trying another location..."),q(!1)})}).then((q)=>{if(!q)return U();return!0})}catch(j){throw console.error("Error in street view search:",j),j}}async function B(){try{return C=(await(await fetch("/api/location/random")).json()).actualLocation,C}catch(j){console.error("Error fetching location:",j),alert("Error fetching location. Please try again.")}}function D(j){if(J)J.setMap(null);J=new google.maps.Marker({position:j,map:O});let A=document.getElementById("guess-btn");A.disabled=!1}function V(){if(J)J.setMap(null),J=null;if(W)W.setMap(null),W=null;if(T)T.setMap(null),T=null}async function x(){if(!J){alert("Please select a location on the map first!");return}$=!1;let j={lat:J.getPosition().lat(),lng:J.getPosition().lng()};try{let q=await(await fetch("/api/guess",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({guessLocation:j,actualLocation:C})})).json();X+=q.score,P(q.score,q.distance),E(j,C);let H=document.getElementById("next-btn");if(Y<F)H.disabled=!1;else setTimeout(()=>{alert(`Game over! Final score: ${X}. Play again?`),X=0,Y=0,I()},2000)}catch(A){console.error("Error calculating score:",A),alert("Error processing your guess. Please try again.")}}function E(j,A){let q=new google.maps.LatLng(Number(A.lat),Number(A.lng));W=new google.maps.Marker({position:q,map:O,icon:{url:"https://maps.google.com/mapfiles/ms/icons/green-dot.png"}}),T=new google.maps.Polyline({path:[{lat:j.lat,lng:j.lng},{lat:q.lat(),lng:q.lng()}],geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2}),T.setMap(O);let H=new google.maps.LatLngBounds;H.extend(new google.maps.LatLng(j.lat,j.lng)),H.extend(new google.maps.LatLng(A.lat,A.lng)),O.fitBounds(H)}function P(j,A){let q=document.getElementById("score");if(q)q.textContent=`Score: ${X} (+${j}) - Distance: ${Math.round(A)} km`}function w(){let j=document.getElementById("round");if(j)j.textContent=`Round: ${Y}/${F}`}window.initialize=N;
