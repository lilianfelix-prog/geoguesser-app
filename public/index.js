var J,T,C=null,W=null,K=null;var H,Z=!0,X=0,Y=0,_=5;function U(){let j=new URLSearchParams(window.location.search),q=j.get("urllat"),A=j.get("urllng");return{urllat:q?parseFloat(q):null,urllng:A?parseFloat(A):null}}function y(){G(),J=new google.maps.Map(document.getElementById("map"),{center:{lat:0,lng:0},zoom:2,streetViewControl:!1,fullscreenControl:!1}),T=new google.maps.StreetViewPanorama(document.getElementById("street-view"),{position:{lat:0,lng:0},pov:{heading:0,pitch:0},zoom:1,addressControl:!1,showRoadLabels:!1}),J.addListener("click",(j)=>{if(Z&&j.latLng)N(j.latLng)}),$()}function G(){let j=document.createElement("div");j.className="game-controls",j.innerHTML=`
      <div class="game-info">
        <div id="score">Score: 0</div>
        <div id="round">Round: 1/${_}</div>
      </div>
      <button id="guess-btn" disabled>Make Guess</button>
      <button id="next-btn" disabled>Next Round</button>
    `,document.getElementsByClassName("controls-container")[0].appendChild(j),document.getElementById("guess-btn")?.addEventListener("click",B),document.getElementById("next-btn")?.addEventListener("click",$)}async function $(){b(),Z=!0,Y++,f();let j=document.getElementById("guess-btn"),q=document.getElementById("next-btn");j.disabled=!0,q.disabled=!0;try{let{urllat:A,urllng:O}=U();if(A!==null&&O!==null)H={lat:A,lng:O};else H=(await(await fetch("/api/location/random")).json()).actualLocation;let I=new google.maps.StreetViewService,V=5000,z=new google.maps.LatLng(H.lat,H.lng);I.getPanorama({location:z,radius:V},(Q,F)=>{if(F===google.maps.StreetViewStatus.OK)if(Q&&Q.location)T.setPano(Q.location.pano),T.setPov({heading:0,pitch:0}),T.setVisible(!0);else console.warn("No Street View found near this location.");else console.warn("No Street View found near this location.")})}catch(A){console.error("Error fetching location:",A),alert("Error fetching location. Please try again.")}}function N(j){if(C)C.setMap(null);C=new google.maps.Marker({position:j,map:J});let q=document.getElementById("guess-btn");q.disabled=!1}function b(){if(C)C.setMap(null),C=null;if(W)W.setMap(null),W=null;if(K)K.setMap(null),K=null}async function B(){if(!C){alert("Please select a location on the map first!");return}Z=!1;let j={lat:C.getPosition().lat(),lng:C.getPosition().lng()};try{let A=await(await fetch("/api/guess",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({guessLocation:j,actualLocation:H})})).json();X+=A.score,D(A.score,A.distance),w(j,H);let O=document.getElementById("next-btn");if(Y<_)O.disabled=!1;else setTimeout(()=>{alert(`Game over! Final score: ${X}. Play again?`),X=0,Y=0,$()},2000)}catch(q){console.error("Error calculating score:",q),alert("Error processing your guess. Please try again.")}}function w(j,q){W=new google.maps.Marker({position:{lat:q.lat,lng:q.lng},map:J,icon:{url:"https://maps.google.com/mapfiles/ms/icons/green-dot.png"}}),K=new google.maps.Polyline({path:[{lat:j.lat,lng:j.lng},{lat:q.lat,lng:q.lng}],geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2}),K.setMap(J);let A=new google.maps.LatLngBounds;A.extend(new google.maps.LatLng(j.lat,j.lng)),A.extend(new google.maps.LatLng(q.lat,q.lng)),J.fitBounds(A)}function D(j,q){let A=document.getElementById("score");if(A)A.textContent=`Score: ${X} (+${j}) - Distance: ${Math.round(q)} km`}function f(){let j=document.getElementById("round");if(j)j.textContent=`Round: ${Y}/${_}`}window.initialize=y;
