var T,O,K=null,Y=null,W=null;var J,D=!0,Z=0,_=0,U=5;function G(){let j=new URLSearchParams(window.location.search),q=j.get("urllat"),A=j.get("urllng");return{urllat:q?parseFloat(q):null,urllng:A?parseFloat(A):null}}function N(){let j=document.createElement("div");j.className="api-login",j.innerHTML=`
      <div class="api-explanation">
        <h2>Google Maps API Key Required</h2>
        <p>This game uses Google Maps and Street View services. To use these features, you need to provide your own Google Maps API key. You can get one for free from the Google Cloud Console.</p>
        <a href="https://console.cloud.google.com/google/maps-apis/credentials" target="_blank" class="api-link">Get your API key here â†’</a>
      </div>
      <form id="api-form">
        <label for="key_input">Enter your Google Maps API key:</label>
        <input type="text" id="key_input" name="api-key" required>
        <button type="submit">Submit</button>
      </form>
    `,document.body.appendChild(j);let q=document.getElementById("api-form"),A=document.getElementById("key_input");q.addEventListener("submit",(C)=>{C.preventDefault();let Q=A.value.trim();if(Q){window.googleMapsApiKey=Q,j.remove();let H=document.createElement("script");H.src=`https://maps.googleapis.com/maps/api/js?key=${Q}&callback=initializeMap`,H.async=!0,H.defer=!0,document.body.appendChild(H)}})}function b(){B(),T=new google.maps.Map(document.getElementById("map"),{center:{lat:0,lng:0},zoom:2,streetViewControl:!1,fullscreenControl:!1}),O=new google.maps.StreetViewPanorama(document.getElementById("street-view"),{position:{lat:0,lng:0},pov:{heading:0,pitch:0},zoom:1,addressControl:!1,showRoadLabels:!1,panControl:!0,zoomControl:!1,fullscreenControl:!1,motionTracking:!1,motionTrackingControl:!1,linksControl:!0,enableCloseButton:!1,visible:!0,panControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}}),T.addListener("click",(j)=>{if(D&&j.latLng)P(j.latLng)}),I()}function B(){document.getElementById("guess-btn")?.addEventListener("click",V),document.getElementById("next-btn")?.addEventListener("click",I)}async function I(){y(),D=!0,_++,M();let j=document.getElementById("guess-btn"),q=document.getElementById("next-btn");j.disabled=!0,q.disabled=!0;try{let{urllat:A,urllng:C}=G();if(A!==null&&C!==null){J={lat:A,lng:C};let Q=new google.maps.StreetViewService,H=5000,X=new google.maps.LatLng(J.lat,J.lng);Q.getPanorama({location:X,radius:H},async($,z)=>{if(z===google.maps.StreetViewStatus.OK&&$&&$.location)O.setPano($.location.pano),O.setPov({heading:0,pitch:0}),O.setVisible(!0);else console.warn("No Street View found for URL parameters location.")})}else await F()}catch(A){console.error("Error fetching location:",A),alert("Error fetching location. Please try again.")}}async function F(){try{let j=await x();if(!j)throw new Error("Failed to fetch a valid location.");J=j;let q=new google.maps.LatLng(J.lat,J.lng);return new Promise((A,C)=>{new google.maps.StreetViewService().getPanorama({location:q,radius:5000},(H,X)=>{if(X===google.maps.StreetViewStatus.OK&&H&&H.location)O.setPano(H.location.pano),O.setPov({heading:0,pitch:0}),O.setVisible(!0),A(!0);else if(X===google.maps.StreetViewStatus.ZERO_RESULTS)console.warn("Rate limit exceeded, waiting before retry..."),setTimeout(()=>{A(!1)},2000);else console.warn("No Street View found, trying another location..."),setTimeout(()=>{A(!1)},1000)})}).then(async(A)=>{if(!A)return await new Promise((C)=>setTimeout(C,1000)),F();return!0})}catch(j){return console.error("Error in street view search:",j),await new Promise((q)=>setTimeout(q,2000)),F()}}async function x(){try{return J=(await(await fetch("/api/location/random")).json()).actualLocation,J}catch(j){console.error("Error fetching location:",j),alert("Error fetching location. Please try again.")}}function P(j){if(K)K.setMap(null);K=new google.maps.Marker({position:j,map:T});let q=document.getElementById("guess-btn");q.disabled=!1}function y(){if(K)K.setMap(null),K=null;if(Y)Y.setMap(null),Y=null;if(W)W.setMap(null),W=null}async function V(){if(!K){alert("Please select a location on the map first!");return}D=!1;let j={lat:K.getPosition().lat(),lng:K.getPosition().lng()};try{let A=await(await fetch("/api/guess",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({guessLocation:j,actualLocation:J})})).json();Z+=A.score,E(A.score,A.distance),w(j,J);let C=document.getElementById("next-btn");if(_<U)C.disabled=!1;else setTimeout(()=>{alert(`Game over! Final score: ${Z}. Play again?`),Z=0,_=0,I()},2000)}catch(q){console.error("Error calculating score:",q),alert("Error processing your guess. Please try again.")}}function w(j,q){let A=new google.maps.LatLng(Number(q.lat),Number(q.lng));Y=new google.maps.Marker({position:A,map:T,icon:{url:"https://maps.google.com/mapfiles/ms/icons/green-dot.png"}}),W=new google.maps.Polyline({path:[{lat:j.lat,lng:j.lng},{lat:A.lat(),lng:A.lng()}],geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2}),W.setMap(T);let C=new google.maps.LatLngBounds;C.extend(new google.maps.LatLng(j.lat,j.lng)),C.extend(new google.maps.LatLng(q.lat,q.lng)),T.fitBounds(C)}function E(j,q){let A=document.getElementById("score"),C=document.getElementById("distance");if(A)A.innerHTML=`${Z} <span class="score-change">(+${j})</span>`;if(C)C.innerHTML=`<span class="distance-value">${Math.round(q).toLocaleString()}</span> km`}function M(){let j=document.getElementById("round"),q=document.getElementById("distance");if(j)j.textContent=`${_}/${U}`;if(q)q.textContent="-"}window.initialize=N;window.initializeMap=b;
